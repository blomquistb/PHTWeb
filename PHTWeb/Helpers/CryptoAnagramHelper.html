<!DOCTYPE html>
<!--
Featue Todo:
    When word is found that matches allow the assignment of that word to the crypto anagram segment and any unique frequency matches should be assigned by clicking on the word.
    Then all tokens assigned should be logically compared to determine if the mapping can be derived and assigned.

    The assigned word should be displayed next to the crypto anagram text.

-->

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>CryptoAnagram Helper</title>
    
    <script src="/es6-shim.js"></script>
    <script src="/jquery-2.1.4.js"></script>
    <script src="/Utils.js"></script>
    <script src="/PHTWords.js"></script>

    <script type="text/javascript">


        ////English letter frequency sequence as  "ETAONRISHDLFCMUGYPWBVKJXQZ"
        ////English letter first letter frequency "TASHWIOBMFCLDPNEGRYUVJKQZX"
        ////common doubled letters "LL EE SS OO TT FF RR NN PP CC"
        ////common letter pairs as "TH HE AN RE ER IN ON AT ND ST ES EN OF TE ED OR TI HI AS TO"

        var gSearchResults = [];
        var gSearchResultsSort = 1;

        var gMaping = [];
        var gMapSorting = 1;
        var gLastAppliedFreq = function (map) {
            map.sort(function (a, b) { if (b.frequency == a.frequency) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.frequency - a.frequency; });
            setAutoApplyHighlight("OccuranceFreqTitle");
            return applyFrequency(map, getOccuranceFreq());
        };

        function doEncryptionChanged() {
            var encryptedTextArea = document.getElementById("Encrypted");

            gMaping = getNewMapping(gMaping, encryptedTextArea.innerText, getExcludeText());

            renderMappingTable(gMaping);
            renderDecryptedText(gMaping);
        }



        function getNewMapping(oldMap, encryptedText, excludeText) {
            var domainChars = "";
            var newMap = [];

            // Calculate new map from encrypted text minus the characters in exludeText.
            //
            var first = true;
            for (var i = 0; i < encryptedText.length; i++) {
                if (!excludeText || (excludeText.indexOf(encryptedText.charAt(i)) < 0)) {
                    var index = domainChars.indexOf(encryptedText.charAt(i));
                    if (index < 0) {
                        newMap.push({ cypher: encryptedText.charAt(i).toUpperCase(), key: encryptedText.charAt(i).toUpperCase(), frequency: 1, double: 0, first: 0 });
                        domainChars = domainChars + encryptedText.charAt(i);
                        index = domainChars.length - 1;
                    }
                    else {
                        newMap[index].frequency++;
                        if (i > 0 && encryptedText.charAt(i - 1) == encryptedText.charAt(i)) {
                            newMap[index].double++;
                        }
                    }

                    if (first) {
                        newMap[index].first = newMap[index].first + 1;
                        first = false;
                    }
                }
                else {
                    if (PHTWords.IsWhitespace(encryptedText.charAt(i))) {
                        first = true;
                    }
                }
            }

            // Copy any remainging locked mappings from the old map to the new map.
            //
            for (var i = 0; i < newMap.length; i++) {
                for (var j = 0; j < oldMap.length; j++) {
                    if (newMap[i].cypher == oldMap[j].cypher) {
                        if (oldMap[j].locked) {
                            newMap[i].locked = true;
                            newMap[i].key = oldMap[j].key;
                        }
                        break;
                    }
                }
            }

            // Apply last mapping strategy used.
            //
            if (getAutoApply()) {
                return gLastAppliedFreq(newMap);
            }

            return newMap;
        }

        ///
        ///
        function decryptText(cypherText, map) {
            var result = "";
            var wasWhiteSpace = true;

            cypherText = cypherText.toUpperCase();

            for (var i = 0; i < cypherText.length; i++) {
                if (PHTWords.IsWhitespace(cypherText.charAt(i))) {
                    if (!wasWhiteSpace) {
                        result = result + '</span>';
                        wasWhiteSpace = true;
                    }
                }
                else {
                    if (wasWhiteSpace) {
                        result = result + '<span onclick="doWordClick(this)">';
                        wasWhiteSpace = false;
                    }
                }

                result = result + getMapping(cypherText.charAt(i), map);;
            }

            return result;
        }

        ///
        ///
        function getMapping(cypherChar, map) {
            var result = cypherChar;

            if (!PHTWords.IsWhitespace(cypherChar)) {
                result = '<span style="color:black;">' + cypherChar + '</span>';
            }

            for (var i = 0; i < map.length; i++) {
                if (cypherChar == map[i].cypher) {
                    if (map[i].locked) {
                        result = '<span style="color:black;">' + map[i].key + '</span>';
                    }
                    else {
                        result = '<span style="color:orange;">' + map[i].key + '</span>';
                    }

                    break;
                }
            }

            return result;
        }

        function getAutoApply() {
            var elem = document.getElementById("AutoApply");
            if (elem && elem.checked) {
                return true;
            }

            return false;
        }

        function setAutoApplyHighlight(title) {
            var titles = ["OccuranceFreqTitle", "FirstFreqTitle", "DoubleFreqTitle"];
            for (var i = 0; i < titles.length; i++) {
                var elem = document.getElementById(titles[i]);
                if (elem) {
                    if (titles[i] == title) {
                        elem.style.backgroundColor = "yellow";
                    }
                    else {
                        elem.style.backgroundColor = "inherit";
                    }
                }
            }
        }

        function applyFrequency(map, freqString) {

            var domainArray = [];
            for (var i = 0; i < map.length; i++) {
                domainArray.push(map[i].cypher);
            }
            domainArray.sort(function (a, b) { return a.charCodeAt(0) - b.charCodeAt(0); });
            var domain = domainArray.join('');

            for (var i = 0; i < map.length; i++) {
                if (map[i].locked) {
                    freqString = freqString.replace(new RegExp(map[i].key.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1'), 'g'), '');
                    domain = domain.replace(new RegExp(map[i].key.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1'), 'g'), '');
                }
            }

            for (var i = 0; i < map.length; i++) {
                if (!map[i].locked) {
                    if (freqString.length > 0) {
                        map[i].key = freqString.substring(0, 1);
                        freqString = freqString.substring(1);
                        domain = domain.replace(new RegExp(map[i].key.replace(/([.*+?^=!:${}()|\[\]\/\\])/g, '\\$1'), 'g'), '');
                    }
                    else if (domain.length > 0) {
                        map[i].key = domain.substring(0, 1);
                        domain = domain.substring(1);
                    }
                    else {
                        map[i].key = '*';
                    }
                }
            }

            return map;
        }



        ///
        ///
        function getExcludeText() {
            var excludeEdit = document.getElementById("Exclude");
            var numCheckbox = document.getElementById("Numbers");
            var puncCheckbox = document.getElementById("Punctuation");
            var wsCheckbox = document.getElementById("Whitespace");

            var result = "";

            if (excludeEdit && excludeEdit.value) {
                result = result + excludeEdit.value;
            }


            if (numCheckbox && numCheckbox.checked) {
                result = result + PHTWords.Digits;
            }

            if (puncCheckbox && puncCheckbox.checked) {
                result = result + PHTWords.Punctuation;
            }

            if (wsCheckbox && wsCheckbox.checked) {
                result = result + PHTWords.Whitespace;
            }

            return result
        }

        function getOccuranceFreq() {
            var freqInput = document.getElementById("OccuranceFreq");

            return freqInput.value;
        }

        function getFirstLetterFreq() {
            var freqInput = document.getElementById("FirstFreq");

            return freqInput.value;
        }

        function getDoubleFreq() {
            var freqInput = document.getElementById("DoubleFreq");

            return freqInput.value;
        }

        function doApplyOccurancyFreq() {
            gLastAppliedFreq = function (map) {
                map.sort(function (a, b) { if (b.frequency == a.frequency) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.frequency - a.frequency; });
                setAutoApplyHighlight("OccuranceFreqTitle");
                return applyFrequency(map, getOccuranceFreq());
            };

            gLastAppliedFreq(gMaping);
            renderMappingTable(gMaping);
            renderDecryptedText(gMaping);
        }

        function doApplyFirstFreq() {
            gLastAppliedFreq = function (map) {
                map.sort(function (a, b) { if (b.first == a.first) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.first - a.first });
                setAutoApplyHighlight("FirstFreqTitle");
                return applyFrequency(map, getFirstLetterFreq());
            };

            gLastAppliedFreq(gMaping);
            renderMappingTable(gMaping);
            renderDecryptedText(gMaping);
        }

        function doApplyDoubleFreq() {
            gLastAppliedFreq = function (map) {
                map.sort(function (a, b) { if (b.double == a.double) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.double - a.double });
                setAutoApplyHighlight("DoubleFreqTitle");
                return applyFrequency(map, getDoubleFreq());
            };

            gLastAppliedFreq(gMaping);
            renderMappingTable(gMaping);
            renderDecryptedText(gMaping);
        }

        function doSortByOccurancyFreq() {
            gMapSorting = 1;
            renderMappingTable(gMaping);
        }

        function doSortByFirstFreq() {
            gMapSorting = 5;
            renderMappingTable(gMaping);
        }

        function doSortByDoubleFreq() {
            gMapSorting = 2;
            renderMappingTable(gMaping);
        }

        function doSortByDomain() {
            gMapSorting = 3;
            renderMappingTable(gMaping);
        }

        function doSortByKey() {
            gMapSorting = 4;
            renderMappingTable(gMaping);
        }

        function doSortByFrequency() {
            gSearchResultsSort = 1;
            renderSearchResults(gSearchResults);
        }

        function doSortByWords() {
            gSearchResultsSort = 2;
            renderSearchResults(gSearchResults);
        }

        function renderSearchResults(data, startTime) {

            switch (gSearchResultsSort) {
                case 1: { data.sort(function (a, b) { return b.frequency - a.frequency; }); break; }
                case 2: { data.sort(function (a, b) { if (a.value > b.value) { return 1; } else if (a.value < b.value) { return -1; } else { return 0; } }); break; }
            }

            gSearchResults = data;

            var table = document.getElementById("ResultsTable");

            table.innerHTML = '';

            var countElem = document.getElementById("ResultsCount");
            if (countElem) {
                if (data) {
                    countElem.value = data.length;
                } else {
                    countElem.value = "";
                }
            }

            for (var i = 0; i < data.length; i++) {
                var r = table.insertRow(-1);
                var c = r.insertCell(-1);
                c.innerHTML = data[i].value;

                c = r.insertCell(-1);
                c.style.textAlign = "right";
                c.innerHTML = data[i].frequency;
            }

            if (startTime) {
                setDuration(new Date().getTime() - startTime);
                beep();
            }
        }

        function renderMappingTable(map) {

            // The sorting methods will call renderMappingTable
            switch (gMapSorting) {
                case 1: map.sort(function (a, b) { if (b.frequency == a.frequency) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.frequency - a.frequency }); break;
                case 2: map.sort(function (a, b) { if (b.double == a.double) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.double - a.double }); break;
                case 3: map.sort(function (a, b) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) }); break;
                case 4: map.sort(function (a, b) { if (b.key.charCodeAt(0) == a.key.charCodeAt(0)) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return a.key.charCodeAt(0) - b.key.charCodeAt(0) }); break;
                case 5: map.sort(function (a, b) { if (b.first == a.first) { return a.cypher.charCodeAt(0) - b.cypher.charCodeAt(0) } return b.first - a.first }); break;
                default: break;
            }

            var countElem = document.getElementById("MapCount");
            if (countElem) {
                countElem.value = map.length;
            }

            var t = document.getElementById("DecryptTable");
            t.innerHTML = '<tr><th><a href="javascript:void(0)" onclick="doSortByOccurancyFreq();" title="ETAONRISHDLFCMUGYPWBVKJXQZ">Occ</a></th><th><a href="javascript:void(0)" onclick="doSortByFirstFreq();" title="TASHWIOBMFCLDPNEGRYUVJKQZX">Frst</a></th><th><a href="javascript:void(0)" onclick="doSortByDoubleFreq();" title="LESOTFRNPC">Dbl</a></th><th><a href="javascript:void(0)" onclick="doSortByDomain();">Dom</a></th><th><a href="javascript:void(0)" onclick="doSortByKey();">Map</a></th><th>Lock</th></tr>';

            for (var i = 0; i < map.length; i++) {
                var r = t.insertRow(-1);

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = map[i].frequency;

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = map[i].first;

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = map[i].double;

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = map[i].cypher;

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = '<input type="edit" size="1" maxlength="1" onkeyup="doMapChange();" style="text-align: center;" value="' + map[i].key + '"/>'

                c = r.insertCell(-1);
                c.style.textAlign = "center";
                c.innerHTML = '<input type="checkbox" onchange="doLockChange();" value="' + map[i].key + '"' + (map[i].locked ? ' checked' : '') + ' />'
            }
        }

        function renderDecryptedText(map) {
            var encryptedTextArea = document.getElementById("Encrypted");
            var decryptedTextArea = document.getElementById("Decrypted");

            decryptedTextArea.innerHTML = decryptText(encryptedTextArea.innerText, map).replace(/\n/g, '<br />');
        }



        function doMapChange() {
            var table = document.getElementById("DecryptTable");

            for (var i = 1, row; row = table.rows[i]; i++) {
                var mapEdit = row.cells[4].firstChild;
                if (gMaping[i - 1].key != mapEdit.value) {
                    gMaping[i - 1].key = mapEdit.value;
                    gMaping[i - 1].locked = true;
                }
            }

            doEncryptionChanged();
        }

        function doLockChange() {
            var table = document.getElementById("DecryptTable");

            for (var i = 1, row; row = table.rows[i]; i++) {
                var mapEdit = row.cells[5].firstChild;
                gMaping[i - 1].locked = mapEdit.checked;
            }

            doEncryptionChanged();
        }

        function doSearch() {
            var cypher = "";
            var searchCypher = document.getElementById("SearchCypher");
            if (searchCypher) {
                cypher = searchCypher.value;
            }

            var pattern = "";
            var searchPattern = document.getElementById("SearchPattern");
            if (searchPattern) {
                pattern = searchPattern.value;
            }

            var anagramPatterns = "";
            if (pattern) {
                var patterns = pattern.split('|');
                for (var i = 0; i < patterns.length; i++) {
                    if (anagramPatterns) {
                        anagramPatterns += "&";
                    }
                    anagramPatterns += "%" + patterns[i] + "%&!%" + patterns[i] + patterns[i][0] + "%";
                }
            }
            var words = PHTWords.GetWordMatches(null, anagramPatterns, null, PHTWords.GetCryptoAnagramIdx(cypher), null, getDictionaries(), getMinFrequency(), getMaxResults(), 0, 0, renderSearchResults);
        }

        function doWordClick(el) {
            renderSearchResults([]);

            var word = PHTWords.TrimPunctuation(el.innerText);
            var pattern = "";
            var patterns = [];

            for (var i = 0; i < word.length; i++) {
                for (var j = 0; j < gMaping.length; j++) {
                    if (word[i] == gMaping[j].key && gMaping[j].locked) {   // TODO: should go from cypher text word which is gurenteed to be unique
                        if (pattern.length && pattern[0] != gMaping[j].key) {
                            patterns.push(pattern);
                            pattern = "";
                        }
                        pattern = pattern + gMaping[j].key;
                        break;
                    }
                }
            }

            if (pattern.length) {
                patterns.push(pattern);
                pattern = "";
            }

            var searchCypher = document.getElementById("SearchCypher");
            if (searchCypher) {
                searchCypher.value = word;
            }

            var searchPattern = document.getElementById("SearchPattern");
            if (searchPattern) {
                searchPattern.value = patterns.join('|');
            }

            doSearch();
        }







        function getDictionaries() {
            var dictionaries = "";

            var elem = document.getElementById("WordList");
            if (elem && elem.checked) {
                dictionaries += "0";
            }

            elem = document.getElementById("ModernEnglish");
            if (elem && elem.checked) {
                dictionaries += "1";
            }

            elem = document.getElementById("MiddleEnglish");
            if (elem && elem.checked) {
                dictionaries += "2";
            }

            return dictionaries
        }

        function getMinFrequency() {
            var result = 0;

            var elem = document.getElementById("MinFrequency");
            if (elem) {
                result = parseInt(elem.value.trim());
                if (isNaN(result)) result = 0;
            }

            return result;
        }

        function getMaxResults() {
            var result = 25;

            var elem = document.getElementById("MaxResults");
            if (elem) {
                result = parseInt(elem.value.trim());
                if (isNaN(result)) result = 25;
            }

            return result;
        }

        function setDuration(duration) {
            var millis = (duration % 1000);
            var seconds = Math.floor((duration / 1000)) % 60;
            var minutes = Math.floor((duration / 1000) / 60);

            var text = ""
            if (minutes < 10) text += "0";
            text += minutes;
            text += ":";
            if (seconds < 10) text += "0";
            text += seconds;
            text += ":";
            if (millis < 10) {
                text += "00";
            } else if (millis < 100) {
                text += "0";
            }
            text += millis;

            var elem = document.getElementById("Duration");
            if (elem) {
                elem.value = text;
            }
        }

        function doGetWordList() {
            PHTWords.Clear();

            var LinesAsWords = false;

            var elem = document.getElementById("LinesAsWords");
            if (elem && elem.checked) {
                LinesAsWords = true;
            }

            elem = document.getElementById("WordListText");
            if (elem) {
                var text = elem.value.trim();
                var lines = text.split("\n");

                for (var i = 0; i < lines.length; i++) {
                    var line = lines[i].trim().replace(/[\s]+/g, ' ');

                    if (LinesAsWords) {
                        PHTWords.AddWord(line, 7000100);
                    }

                    var words = line.split(" ");
                    if (words.length > 1) {
                        for (var j = 0; j < words.length; j++) {
                            PHTWords.AddWord(words[j], 7000000);
                        }
                    }
                }
            }
        }


    </script>
</head>
<body onload="doEncryptionChanged();">

    <table style="width:100%;">
        <tr>
            <td style="vertical-align:top;">
                <span>Count:</span>
                <input type="text" size="5" disabled="disabled" id="MapCount" />
                <label><input type="checkbox" id="AutoApply" checked="checked" value="1" onchange="doEncryptionChanged();" />Auto Apply</label>
                <br />
                <hr />
                <table id="DecryptTable">
                </table>
            </td>
            <td style="vertical-align:top;border-right: 3px solid black;border-left: 3px solid black;padding-left:5px; padding-right:10px;">
                <span>Exclude:</span>
                <input type="text" id="Exclude" onkeyup="doEncryptionChanged();" value="+-"/>
                <label><input type="checkbox" id="Numbers" checked="checked" value="Numbers" onchange="doEncryptionChanged();" />Numbers</label>
                <label><input type="checkbox" id="Punctuation" checked="checked" value="Punctuation" onchange="doEncryptionChanged();" />Punctuation</label>
                <label><input type="checkbox" id="Whitespace" checked="checked" value="Whitespace" onchange="doEncryptionChanged();" />Whitespace</label>
                <br />
                <hr />

                <table style="width:100%">
                    <tr>
                        <td colspan="2">English Frequency:</td>
                    </tr>
                    <tr>
                        <td id="OccuranceFreqTitle" style="text-align:right;">
                            Occurance:
                        </td>
                        <td>
                            <input type="text" id="OccuranceFreq" value="ETAONRISHDLFCMUGYPWBVKJXQZ" size="50" />
                            <button onclick="doApplyOccurancyFreq()">Apply</button>
                        </td>
                    </tr>
                    <tr>
                        <td id="FirstFreqTitle" style="text-align:right;">
                            First Letter:
                        </td>
                        <td>
                            <input type="text" id="FirstFreq" value="TASHWIOBMFCLDPNEGRYUVJKQZX" size="50" />
                            <button onclick="doApplyFirstFreq()">Apply</button>
                        </td>
                    </tr>
                    <tr>
                        <td id="DoubleFreqTitle" style="text-align:right;">
                        Double:
                        </td>
                        <td>
                            <input type="text" id="DoubleFreq" value="LESOTFRNPC" size="50" />
                            <button onclick="doApplyDoubleFreq()">Apply</button>
                        </td>
                    </tr>
                </table>
                <br />
                <hr />

                <span>Decrypted:</span>
                <div id="Decrypted" style="width:100%;height:250px;overflow-y:scroll;font-family:Courier New, Courier, monospace;font-size:12px;border: 1px solid black;padding:2px;"></div>
                <span>Encrypted:</span>
                <textarea id="Encrypted" style="width:100%;height:250px;font-family:Courier New, Courier, monospace;font-size:12px;" onkeyup="doEncryptionChanged();"></textarea>

            </td>
            <td style="vertical-align:top;">
                <span>Dictionary:</span>
                <label><input type="checkbox" id="ModernEnglish" checked="checked" value="1" />Modern&nbsp;English</label>
                <label><input type="checkbox" id="MiddleEnglish" value="2" />Middle&nbsp;English</label>
                <label><input type="checkbox" id="WordList" value="0" />Word&nbsp;List</label>
                <hr />
                <table style="width:100%;">
                    <tr>
                        <td>Cypher:</td>
                        <td><input type="text" id="SearchCypher" size="50"/></td>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td>Pattern:</td>
                        <td><input type="text" id="SearchPattern" size="50" /></td>
                        <td>&nbsp;</td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <label>Min Frequency: <input type="text" id="MinFrequency" size="10" value="0" title="Modern English (BNC):
  0 = 700,000 words
  1 = 80,000 words
  15 = 60,000 words
  50 = 40,000 words
  200 = 20,000 words
  500 = 10,000 words
  1500 = 5,000 words
  4000 = 2,500 words
  10000 = 1,000 words
" /></label>
                            <label title="Attempt to stem word if no matches found."><input type="checkbox" disabled="disabled" id="EnableStemming" value="1" />Enable Stemming</label>
                        </td>
                        <td style="text-align:right;"><button onclick="doSearch();">Search</button></td>
                    </tr>
                </table>
                <hr />
                <label>Results: <input type="text" size="5" disabled="disabled" id="ResultsCount" /></label>
                <label>Duration: <input type="text" size="12" disabled="disabled" id="Duration" /></label>
                <label>Max Results: <input type="text" maxlength="4" id="MaxResults" size="5" value="999" /></label>
                <br />
                <hr />
                <table id="Table1" style="width:100%;">
                    <tr>
                        <th style="text-align:left;"><a href="javascript:void(0)" onclick="doSortByWords();">Words</a></th>
                        <th style="text-align:right;"><a href="javascript:void(0)" onclick="doSortByFrequency();">Frequency</a></th>
                    </tr>
                </table>
                <div style="height:525px;overflow-y:auto;border:1px solid black;">
                    <table id="ResultsTable" style="width:100%;">
                    </table>
                </div>
               <br />
                <span>Word List:</span>
                <label><input type="checkbox" id="LinesAsWords" onclick="doGetWordList();" checked="checked" value="1" />Lines Are Words</label>
                <textarea id="WordListText" style="width:100%;height:250px;font-family:Courier New, Courier, monospace;font-size:12px;" onkeyup="doGetWordList();"></textarea>
             </td>
        </tr>
    </table>

</body>
</html>
